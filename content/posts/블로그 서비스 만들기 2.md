---
title: 블로그 서비스 만들기 2
createdTime: 2023-03-05
tags:
    - projects
    - portfolio
    - 블로그
description:
---

## 개요

기존에 사용하던 블로그를 대체하기 위한 개발을 진행했다.

## 개발 과정

### 노션 api 연결

우선 노션 api를 간단하게 연결해 보았다.

1. 노션 클라이언트를 연결한다. 노션 api 키는 [Notion API](https://developers.notion.com/) 에서 받을 수 있다.
```tsx
// notion.ts
import { Client } from '@notionhq/client';

const notion = new Client({
  auth: process.env.NEXT_PUBLIC_PRIVATE_NOTION_API_KEY,
});

export default notion;
```

2. 노션 api를 통해 데이터베이스를 테스트한다. 그 전에 notion에서 데이터베이스를 api키와 통합하는 과정을 거쳐야한다. 연결은 노션의 가장 오른쪽 위쪽의 ...을 클릭하여 아래쪽의 `연결`을 클릭하여 공개할 수 있다.
![image](https://user-images.githubusercontent.com/56826914/222960552-3f17e345-062f-4b12-9e19-0c80a03b34b1.png)
3. 검색 api를 통해 데이터베이스 리스트를 불러온다.

```tsx
// pages/api/posts/index.ts

// Next.js API route support: https://nextjs.org/docs/api-routes/introduction
import notion from '../../notion';
import type { NextApiRequest, NextApiResponse } from 'next';

const databaseId = process.env.NEXT_PUBLIC_DATABASE_ID;
const apiKey = process.env.NEXT_PUBLIC_PRIVATE_NOTION_API_KEY;

const handler = async (req: NextApiRequest, res: NextApiResponse) => {
  try {
    if (!databaseId || !apiKey)
      throw new Error('Missing notion api key or DB id.');

    const { results } = await notion.databases.query({
      database_id: databaseId,
      filter: {
        property: '공개',
        checkbox: {
          equals: true,
        },
      },
      sorts: [
        {
          timestamp: 'created_time',
          direction: 'descending',
        },
      ],
    });

    return res.status(200).json(results);
  } catch {
    return res.status(400).json({
      message: 'bad request.',
    });
  }
};

export default handler;
```
```tsx
import { useEffect } from 'react';
import getPosts from '../../api/posts';

const Page = () => {
  useEffect(() => {
    (async () => {
      try {
        const response = await getPosts();

        console.log(response);
      } catch (error) {
        console.error(error);
      }
    })();
  }, []);
  return <div />;
};

export default Page;
```
```text
[
    {
        "object": "page",
        "cover": null,
        "createdBy": {
            "object": "user",
            "id": ...
        },
        "createdTime": ...,
        "archived": false,
        "icon": null,
        "id": ...,
        "title": ...,
        "description": ...,
        "lastEditedTime": ...
    },
]
```
검색 결과 데이터베이스에 있는 페이지들이 잘 노출되는 것이 확인된다.

### 페이지 내부 컨텐츠를 출력

페이지 내부의 데이터를 가져와야만 블로그 포스트를 만들 수 있다. 그렇지만 Notion api는 데이터 베이스를 쿼리하는 기능, 페이지 단위로 데이터를 찾는 api가 있지만 노션 자체가 블록 데이터로 이루어져 있기 때문에 블로그 글로 표현하기 위해서는 추가적인 변환 (블록 단위 데이터를 마크 다운 형식으로 변환)하는 작업이 필요하다.

모든 블록들을 찾고 이를 마크다운으로 변환하는 과정은 `notion-to-md`라는 라이브러리를 이용하여 변환하는 과정을 거쳤다. 그리고 마크다운을 출력하는 과정은 `react-markdown` 라이브러리를 이용했다.

![server_test](https://user-images.githubusercontent.com/56826914/223120697-a73d9d7a-28b9-4143-b933-f38df112b5b8.gif)


화면에 제대로 출력되는 것을 확인할 수 있다.

### 문제점

동작은 제대로 되고 있으나, 다소 치명적인 문제점을 확인할 수 있었다.
마크다운 텍스트를 변환하는 작업을 next.js의 `pages/api`를 통해 클라이언트 사이드 렌더링으로 개발을 진행했다.
그러나 notion api의 문제인지, 응답 속도가 빠를 때는 빠르게 컨텐츠를 표시할 수 있었으나 그렇지 못할 경우 매우 오랜 시간동안 흰 화면만 나타나는 문제가 있다.
또한 로딩 중에 스켈레톤이 적용되도록 설정했는데, 동작 화면을 보면 알 수 있듯이 스켈레톤이 적용되지 않는 문제가 있었다. 이는 데이터를 불러왔으나 이를 마크다운으로 표시하는데 많은 시간이 소요됨을 뜻하는 것 같았다.
노션에서 작성한 글과 실시간으로 연동되는 부분은 좋았으나, 평균 속도가 너무 느렸기 때문에 이대로 내보내기에는 부족함이 많았다. 따라서 다른 방법을 생각해야 했다.

